name: Stream Browser Automation

on:
  schedule:
    # Run every 10 minutes
    - cron: "*/14 * * * *"
  workflow_dispatch:

env:
  PY_COLORS: "1"
  PYTHON_VERSION: "3.13"
  OS: ubuntu-latest
  WARP_API_ENDPOINT: https://www.cloudflare.com/cdn-cgi/trace

jobs:
  automation:
    name: Run Stream Automation
    runs-on: ${{ env.OS }}
    
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        python-version: ["3.13"]
        os: [ubuntu-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Configure system locale
        run: |
          set -e
          echo "Configuring system locale..."
          sudo apt-get -y update
          sudo apt-get install -y --no-install-recommends tzdata locales
          sudo locale-gen en_US.UTF-8
          sudo localectl set-locale LANG="en_US.UTF-8"
          export LANG="en_US.UTF-8"
          sudo update-locale
          localectl status
        shell: bash

      - name: Install and configure Cloudflare WARP
        run: |
          set -e
          echo "Installing Cloudflare WARP..."
          curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | \
            sudo gpg --yes --dearmor --output /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
          
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" | \
            sudo tee /etc/apt/sources.list.d/cloudflare-client.list
          
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends cloudflare-warp
          
          echo "Configuring WARP..."
          sudo warp-cli --accept-tos registration new
          sudo warp-cli --accept-tos mode warp+doh
          sudo warp-cli --accept-tos connect
          
          sleep 5
          echo "WARP installation complete"
        shell: bash

      - name: Verify WARP connection
        run: |
          echo "Verifying WARP connection..."
          if curl -s "${{ env.WARP_API_ENDPOINT }}" | grep -q "warp=on"; then
            echo "✓ WARP connection verified"
          else
            echo "✗ WARP connection failed"
            exit 1
          fi
        shell: bash

      - name: Install Python dependencies
        run: |
          set -e
          echo "Installing Python dependencies..."
          python -m pip install --upgrade pip wheel setuptools
          
          python -m pip install \
            --upgrade \
            seleniumbase \
            pyautogui \
            pymongo \
            python-xlib
          
          echo "Dependencies installed successfully"
        shell: bash

      - name: Install ChromeDriver
        run: |
          echo "Installing ChromeDriver..."
          seleniumbase install chromedriver
          echo "ChromeDriver installation complete"
        shell: bash

      - name: Run browser automation script
        run: |
          echo "Starting browser automation..."
          python ve.py \
            --brave \
            --incognito \
            --do-not-track \
            --xvfb \
            --screenshot
          echo "Browser automation completed"
        shell: bash

      - name: Upload screenshots and logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: automation-artifacts
          path: |
            ./latest_logs/
          retention-days: 7
          if-no-files-found: warn

      - name: Notify on failure
        if: failure()
        run: |
          echo "⚠️  Browser automation job failed"
          exit 1
        shell: bash
